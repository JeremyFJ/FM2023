---
title: "Population dynamics and Surplus Production"
author: "(Your name here)"
date: "2/9/23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
lab_path = dirname(rstudioapi::getSourceEditorContext()$path)
knitr::opts_knit$set(root.dir = lab_path)
getwd()
set.seed(9999)
```

You will need the following packages installed and loaded. 
```{r message=FALSE}
library(nlstools)
library(tidyverse)
library(magrittr)
library(FSA)
library(rfishbase)
```  

# Population Dynamics

## Exponential Growth model
$$
N_t = N_0e^{(b-d)t}
$$
`Nt` = population size at time
`N0` beginning population size
`b` = birth rate
`d` = death rate
`t` = time

Exponential growth of a hypothetical population using different birth and death rates.
```{r examplebox2.1}
b = c(0.2,0.2,0.2) # birth rates
d = c(0.04,0.1,0.2) # death rates
N0 = c(500,500,500) # starting populations

Time = seq(0,20,0.5) # time steps
Nt = matrix(NA, nrow = length(Time), ncol = 3)
for (i in 1:3){
  Nt[,i] = N0[i]*exp((b[i]-d[i])*Time)
}

Nt_dat = data.frame(Nt)
colnames(Nt_dat) = c('T1', 'T2', 'T3')
ggplot() + geom_line(aes(x=Time, y=Nt_dat$T1)) +
  geom_line(aes(x=Time, y=Nt_dat$T2),col=2) +
  geom_line(aes(x=Time, y=Nt_dat$T3), col=3) + 
  labs(x="Time", y="Population size (Nt)")
```

## Logistic Population Growth


$$
N_{t+1} = N_t + rN_t(1-N_t/K) - C_t 
$$
`Nt+1` = population size at timestep t+1
`Nt` = population size at time
`r` = rate of increase
`K` = carrying capacity
`C_t` = harvest rate  

```{r}
colors = c("0"="grey76", "10"="grey60", "20"="black")
r = 0.5
K = 1000
N0 = 50
Time = seq(0,25,1)
Nt = c()
Nt[1] = N0
#-----------------------
# Catch = 0
#-----------------------
for (i in 1:25){
  Nt[i+1] = Nt[i] + r*Nt[i]*(1-Nt[i]/K)
}
Nt0 = Nt
Ct = 10
#-----------------------
# Catch = 10
#-----------------------
for (i in 1:25){
  Nt[i+1] = Nt[i] + r*Nt[i]*(1-Nt[i]/K) - Ct
}
Nt1 = Nt
Ct = 20
#-----------------------
# Catch = 20
#-----------------------
for (i in 1:25){
  Nt[i+1] = Nt[i] + r*Nt[i]*(1-Nt[i]/K) - Ct
}
Nt2 = Nt

ggplot() + 
  geom_line(aes(x=Time, y=Nt0, color="0"), size=1.5) +
  geom_line(aes(x=Time, y=Nt1, color="10"), size=1.5) +
  geom_line(aes(x=Time, y=Nt2, color="20"), size=1.5) + 
  labs(x="Time", 
       y="Population size",
       color="Catch") +
    scale_color_manual(values = colors)
```
  
Now we look at intrinsic growth rates > 1 which should lead to unstable and oscillatory population dynamics. 
```{r fig2.6}
r = 0.25
K = 1000
N0 = 1
Time = seq(0,100,1)
Nt = c()
Nt[1] = N0
Ct = 0
for (i in 1:100){
  Nt[i+1] = Nt[i] + r*Nt[i]*(1-Nt[i]/K) - Ct
}
par(mfrow  = c(2,2))
plot(Nt~Time, type = "l", ylim = range(Nt), main="r=0.25")
r = 1.85
for (i in 1:100){
  Nt[i+1] = Nt[i] + r*Nt[i]*(1-Nt[i]/K) - Ct
}
plot(Nt~Time, type = "l", ylim = range(Nt), main="r=1.85")
r = 2.5
for (i in 1:100){
  Nt[i+1] = Nt[i] + r*Nt[i]*(1-Nt[i]/K) - Ct
}
plot(Nt~Time, type = "l", ylim = range(Nt), main="r=2.5")
r = 3
for (i in 1:100){
  Nt[i+1] = Nt[i] + r*Nt[i]*(1-Nt[i]/K) - Ct
}
plot(Nt~Time, type = "l", ylim = range(Nt), main="r=3")
```

## Surplus Production

Now let's plot the phase diagram of the discrete logistic population growth.
```{r phaseDiag}
r = 0.5
K = 1000
N0 = 50
Time = seq(0,100,1)
Nt = c()
Nt[1] = N0
for (i in 1:100){
  Nt[i+1] = Nt[i] + r*Nt[i]*(1-Nt[i]/K)
}
plot(Nt[1:99],Nt[2:100], type = "l")
lines(Nt,Nt, lty = 2)
```
The difference in population abundance between the strait dotted line and the curved line is the surplus production, which theoretically should be maximum at `k/2`. 

Let's see that in terms of yield.
```{r MSY}
par(mfrow=c(1,2))
plot(1:50, Nt[1:50], type = "l") 
Y = Nt[2:50] - Nt[1:49]
plot(Y~Nt[1:49],type = "l")
```

$$
B_{max} \approx K
$$
\\
$$
\text{Schaefer}\\
B_{t+1} = B_t + rB_t(1-B_t/K)-C_t\\
\text{Fox}\\
B_{t+1} = B_t + rB_t(1-logB_t/logK)-Ct
$$

`Bt` = exploitable population biomass at time (t)
`r` = intrinsic rate of population increase
`K` = carrying capacity
`Ct` = catch at time (t)

```{r}
# install.packages('remotes')
# remotes::install_github("haddonm/datalowSA")
library(datalowSA)
data(dataspm)
fish = dataspm$fish
```

```{r}
pars = c(r=0.2,K=6000,Binit=2800) # initial parameters
depletion = pars[[3]]/pars[[2]] # annual depletion based on above parameters, Binit/K

B = c()
B[1] = pars["Binit"]
C = fish$catch
time = seq(1,30,1)

for (i in time) {
  B[i+1] = B[i] + pars["r"]*B[i]*(1-B[i]/pars["K"]) - C[i]
}

ggplot() + 
  geom_line(aes(x=time, y=B[1:30])) + 
  xlab("Time") + 
  ylab("Population Biomass") +
  ggtitle("Schaefer Surplus Production") +
  theme(panel.grid = element_line(colour="black", size=0.08),
        panel.border = element_rect(fill=NA))
```

## VPA 









