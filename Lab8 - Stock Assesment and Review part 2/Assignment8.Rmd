---
title: "Assignment 8 -- Virtual Population Analysis and Yield Per Recruit"
author: "(Your name here)"
date: "3/16/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
lab_path = dirname(rstudioapi::getSourceEditorContext()$path)
knitr::opts_knit$set(root.dir = lab_path)
set.seed(9999)
require(TropFishR)
```

1) Use the Catch-at-Age data below to simulate a population of vulnerable recruits `assuming fishing mortality = 0.2 for the oldest age class.`

- Estimated catch-at-age for Gulf Menhaden (Brevoortia patronus), 1964-2004 from the reduction
fishery in the U.S. Gulf of Mexico. `Catch unit = millions of fish`
- “Rule of thumb” (Hewitt & Hoenig 2005) `M = 3/tmax`
- Lifespan of Atlantic menhaden `~11 years`
- `Report N`
```{r}
menhaden = FSAdata::Menhaden1
head(menhaden)
```

```{r}
C = as.numeric(menhaden[19,][3:8]) # Menhaden catch in 1982 for ages 1-6
```

2) Use the average weight-at-age for Atlantic Menhaden (reconstructed from Turner 2017) to calculate yield per recruit AND biomass per recruit for 1982? 

```{r}
W = c(0.68, 1.3, 1.89, 2.09, 2.5, 2.8)
```

*BONUS*
3) Modify the `getYpR` function for the Menhaden analysis you conducted in questions 1-2. What is the optimal fishing mortality rate for maximum YPR? Could they have fished more or not?

```{r}
getYpR = function(Fi){
  N0 = 100
  years = 1:10

  M = 0.2
  Z = Fi+M
  Nt = c(N0,N0*exp(-(Fi+M)*years[1:9]))
W = c(0.6,0.9,2.1,4.1,6.3,8.4,10,11.2,12.6,13.5)
Pb = Nt*W # Population biomass
Cn = Fi/(Z)*Nt*(1-exp(-Z)) # catches in Numbers
Cw = Cn*W
Y = sum(Cw)

# Yield per recruit
YpR = Y/N0
# Biomass per recruit
BpR = sum(Pb)/N0
c(YpR = YpR,BpR = BpR)
}
```

```{r}
Fis = seq(0,1,.1) # range of fishing mortality values 

dat = do.call(rbind, lapply(Fis, getYpR)) # apply the function to all elements of Fis and then combine the results in a table
dat = as.data.frame(dat) # we need to make sure this table is a data.frame
dat$Fi = Fis

par(mar = c(5,5,2,5)) # set the margins for the plotting device
plot(YpR~Fi, dat, type = "l", axes = FALSE, ylab = "Yield per Recruit (kg)")
axis(1)
axis(2)
par(new = T) # allows overplotting on the same figure
plot(BpR~Fi, dat, type = "l", lty = 2, axes=FALSE, xlab=NA, ylab=NA, ylim = c(0,20)) # this is the dashed line
axis(side = 4)
mtext(4,line = 3 ,text = "Biomass per Recruit (kg)")
# best Fi
abline(v = dat$Fi[dat$YpR==max(dat$YpR)], lty = 2)
text(0.6, 0.1, expression('Fi at max YpR'))
text(0.85,0.42, expression('BpR'))
text(0.82,18, expression('YpR'))
```