---
title: "Lab 10 - Kennedy Lakes Assessment"
author: "(Your name here)"
date: "4/6/2023"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
lab_path = dirname(rstudioapi::getSourceEditorContext()$path)
knitr::opts_knit$set(root.dir = lab_path)
set.seed(9999)
library(tidyverse)
library(rfishbase)
```

# Kennedy Tree Farm dataset

```{r}
dat = read.csv("kennedylakes.csv")
```

### Data Exploration

From a 3-year sampling event, what is the species distribution across all 4 lakes? 
```{r, fig.width=120%}
ggplot(data=dat, aes(x=common)) +
  geom_bar() +
  theme_bw() +
  xlab("Catch") +
  ggtitle("Kennedy lakes species distribution")
```

Calculate the proportion of catch by species 
```{r}
specs = aggregate.data.frame(list(inds = dat$date), list(common = dat$common), length) # create aggregated dataframe with 2 columns (species, catch)
specs = specs[order(specs$inds),] # order dataframe by descending catch
specs$perc = specs$inds/sum(specs$inds)*100 # create proportion
par(oma = c(1,7,2,1))
barplot(specs$inds, names.arg = paste(specs$common," (",round(specs$perc,1),"%)",sep = ""), horiz=T, las = 1)
```

What is the overall catch and effort per lake? How would you develop relative abundance indices from this information?
```{r} 
g1 = ggplot(data=dat, aes(x=lake)) +
  geom_bar() + # create a barplot to count how many rows pertain to each lake
  theme_bw() +
  xlab("Lake") +
  ylab("Catch") +
  ggtitle(paste0("Kennedy lakes (Nov 2021 - Apr 2023)"))
g2 = ggplot(data=dat, aes(x=lake, y=time_targeted)) +
  geom_bar(position="stack", stat="identity") + # barplot of fishing effort per lake
  theme_bw() +
  xlab("Lake") +
  ylab("Effort (hours)") 
gridExtra::grid.arrange(g1, g2)
```

Length frequency distribution of `largemouth bass` from 2021-2023. 
```{r}
dat_2021 <- dat[(dat$date > "2021-01-01" & dat$date < "2022-01-01" 
                 & dat$common=='largemouth bass' & !is.na(dat$length_cm)),] # subset for 2021 sampling events and largemouth bass. Remove rows without length measurements 
dat_2022 <- dat[(dat$date > "2022-01-01" & dat$date < "2023-01-01" 
                 & dat$common=='largemouth bass' & !is.na(dat$length_cm)),]
dat_2023 <- dat[(dat$date > "2023-01-01" & dat$date < "2024-01-01" 
                 & dat$common=='largemouth bass' & !is.na(dat$length_cm)),]
par(mfrow=c(1,3))
hist(~length_cm,data=dat_2021, xlab="Total Length (cm)", col = "black", main="Largemouth Bass 2021")
hist(~length_cm,data=dat_2022, xlab="Total Length (cm)", col = "black", main="2022")
hist(~length_cm,data=dat_2023, xlab="Total Length (cm)", col = "black", main="2023")
```

Plot empirical cumulative distribution function (ECDF) which is the proportion of fish
that are less than each observed length. From this plot, it appears that largemouth bass were relatively the same lengths for all years, however in the 25-30cm range, the proportion of fish increased over the sampling period.
```{r}
clr <- c("black","gray55", "gray")
plot(ecdf(dat_2021$length_cm),xlab="Total Length (cm)",do.points=FALSE,
verticals=TRUE,main="",col.01line=NULL) # plot the ECDF for 2021 sampling events
plot(ecdf(dat_2022$length_cm),add=TRUE,do.points=FALSE,
verticals=TRUE,col=clr[2],col.01line=NULL)
plot(ecdf(dat_2023$length_cm),add=TRUE,do.points=FALSE,
verticals=TRUE,col=clr[3],col.01line=NULL)
legend("bottomright",c("2021","2022", "2023"),col=clr,lty=1,
bty="n",cex=0.75)
```

Convert length classes of largemouth bass caught in 2022 into age classes. Use the VBGF and rfishbase life history parameters.
```{r}
lhB = as.data.frame(popgrowth("Micropterus salmoides", fields = c("K","to","Loo"))) # parameters: Loo, growth coefficient k
meanpar = colMeans(lhB, na.rm=TRUE) # Loo is in cm
dat_2022$age = TropFishR::VBGF(L = dat_2022$length_cm, list(Linf=meanpar["Loo"], K=meanpar["K"], t0= meanpar["to"])) # we need to divide by ten because MEDITS data are reported in millimeters
dat_2022$age = round(dat_2022$age)

afl = data.frame(table(dat_2022$age))
colnames(afl) = c("age", "catch")
afl$age = as.numeric(afl$age)
afl
```

Plot the age class distribution.
```{r, fig.width=2}
ggplot() + 
  geom_point(data=afl, aes(x=age, y=log(catch)), pch=19) + 
  xlab("Age (years)") + 
  ylab("Log Catch") + 
  theme_bw()
```
Linear regression of catch for gear-vulnerable ages. The slope is equal to the total mortality rate.
```{r}
mod1 = lm(log(catch)~age, afl[-c(1),])
# summary(mod1)
# coef(mod1)
z = -coef(mod1)["age"]

plot(log(catch)~age, afl, pch=16, main="KTF largemouth bass 2022")
lines(predict(mod1)~afl$age[2:6])
text(4, 3, paste0("Z=", round(z,3)),
     cex=1,col="black", )
```

### Closed Population, Single Recapture

The most simple and common capture-recapture study occurs when M fish
are collected from a closed population, marked with either a batch or individual mark, and returned to the population.
$$
\text{Chaptman modification of the Petersen equation}\\
\hat{N} = \frac{(M + 1)(n +1)}{m + 1} - 1\\
\hat{N} = \text{total population size}\\
M = \text{tagged fish}\\
n = \text{subsequent sample of fish}\\
m = \text{recaptured fish}
$$
Big Lake largemouth bass recapture from Thursday 3/30/2023.
```{r}
datrecap2023 = dat[(!is.na(dat$tagid) & dat$tagid!='' & dat$date > "2023-01-01"),] # subset master dataframe for only tagged fish caught in 2023
recaprows = which(grepl("recap", tolower(datrecap2023$notes))) # explore the rows where recaptures were reported. Which of these are from Big Lake, and which of these were tagged on our class trip on March 30th?
bigrecap2023 = datrecap2023[c(49,69),] # Brendan and Tom caught recaptures from the class trip
```

Estimate population size of gear-vulnerable fish with the Chapman-modification to the Petersen equation (Krebs 1989).
```{r}
M = nrow(subset(datrecap2023, (common=="largemouth bass" & lake=="big" & date=="2023-03-30"))) # amount of tagged fish from the class trip
n = nrow(subset(dat, (common=="largemouth bass" & lake=="big" & date>"2023-03-30"))) # amount of tagged+recaptured fish sampled after the class trip
m = nrow(bigrecap2023) # amount of recaptured fish from M

mr = FSA::mrClosed(M = M, n = n, m = m, method="Chapman", chapman.mo=TRUE) # FSA function for mark-recapture in a closed system
mrsum = summary(mr, incl.SE=TRUE) # Use Poisson distribution when m < 50 or m/n > 0.1, otherwise use binomial distribution
mrsum
confint(mr, verbose=TRUE)
```

This model assumes the following:
1. The population is physically (i.e., no immigration or emigration) and demographically (i.e., no recruitment or mortality) closed.
2. Marks or tags are neither lost nor missed.
3. Marked fish returned to the population mix randomly with unmarked fish.
4. All fish within a sample have an equal probability of capture.
5. Fish behavior or vulnerability does not change after being marked.





